# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ª–∏–º–∏—Ç–æ–≤

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ Premium –≤–æ –≤—Å–µ—Ö API**
**–ë—ã–ª–æ:** –ü—Ä–æ–≤–µ—Ä—è–ª—Å—è —Ç–æ–ª—å–∫–æ `premium_tokens`, –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∞—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å `users`  
**–°—Ç–∞–ª–æ:** 
- **Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: `users` (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã) ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ `premium_tokens`
- **Web –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: —Ç–æ–ª—å–∫–æ `premium_tokens`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è**: `premium_until <= now` –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ API:**
- `/api/ads` (—Å–æ–∑–¥–∞–Ω–∏–µ, –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ)
- `/api/premium` (check-photo-limit, increment-photo-count, toggle-premium)
- `/api/neon-messages` (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ)

### 2. **–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤**
**–ë—ã–ª–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `CURRENT_DATE` (UTC –≤—Ä–µ–º—è)  
**–°—Ç–∞–ª–æ:** –í—Ä–µ–º—è –ø–æ –ê–ª–º–∞—Ç—ã (UTC+5) –¥–ª—è –≤—Å–µ—Ö –ª–∏–º–∏—Ç–æ–≤

```typescript
const nowUTC = new Date();
const almatyDate = new Date(nowUTC.getTime() + (5 * 60 * 60 * 1000));
const currentAlmatyDate = almatyDate.toISOString().split('T')[0];
```

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Å—á–µ—Ç—á–∏–∫–∏:**
- `ads_created_today` (—Å–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç)
- `photos_sent_today` (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ)
- `pin_uses_today` (–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç)

### 3. **Web-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç web_user_limits**
**–ë—ã–ª–æ:** –°—á–∏—Ç–∞–ª–æ—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `ads` –∫–∞–∂–¥—ã–π —Ä–∞–∑ (–º–µ–¥–ª–µ–Ω–Ω–æ)  
**–°—Ç–∞–ª–æ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ `web_user_limits` (–±—ã—Å—Ç—Ä–æ)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ web_user_limits:**
- `user_token` (PRIMARY KEY)
- `ads_created_today`
- `photos_sent_today`
- `ads_last_reset`
- `photos_last_reset`

### 4. **–£–±—Ä–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ ads –¥–ª—è –ø–æ–∏—Å–∫–∞ tg_id**
**–ë—ã–ª–æ:**
```sql
SELECT tg_id FROM ads WHERE user_token = ${token} LIMIT 1
```

**–°—Ç–∞–ª–æ:**
```sql
SELECT id FROM users WHERE user_token = ${token} LIMIT 1
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë—ã—Å—Ç—Ä–µ–µ (–∏–Ω–¥–µ–∫—Å –Ω–∞ users.user_token)
- –ù–∞–¥–µ–∂–Ω–µ–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–µ –∏–º–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–π)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ (users - –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)

## üìä –¢–∞–±–ª–∏—Ü–∞ –ª–∏–º–∏—Ç–æ–≤

| –§—É–Ω–∫—Ü–∏—è | FREE | PRO |
|---------|------|-----|
| **–ê–Ω–∫–µ—Ç—ã –≤ –¥–µ–Ω—å** | 1 | 3 |
| **–§–æ—Ç–æ –≤ –¥–µ–Ω—å** | 5 | –ë–µ–∑–ª–∏–º–∏—Ç (999999) |
| **–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ** | 1 —Ä–∞–∑ –≤ 3 –¥–Ω—è | 3 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å |

## üîÑ –õ–æ–≥–∏–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤

–í—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –≤ **00:00 –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ê–ª–º–∞—Ç—ã (UTC+5)**:

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
const lastResetDate = limitsData.ads_last_reset ? 
  new Date(limitsData.ads_last_reset).toISOString().split('T')[0] : null;

if (lastResetDate !== currentAlmatyDate) {
  // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞
  await sql`
    UPDATE user_limits
    SET ads_created_today = 0,
        ads_last_reset = ${currentAlmatyDate}::date
    WHERE user_id = ${userId}
  `;
}
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Premium

### Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–µ—Å—Ç—å user_token –ò tg_id):
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º `users.is_premium` –∏ `users.premium_until`
2. –ï—Å–ª–∏ Premium –∞–∫—Ç–∏–≤–µ–Ω –∏ –Ω–µ –∏—Å—Ç–µ–∫ ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ `premium_tokens`
3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å Premium

### Web –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ç–æ–ª—å–∫–æ user_token):
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º `premium_tokens.is_premium` –∏ `premium_tokens.premium_until`
2. –ï—Å–ª–∏ Premium –∞–∫—Ç–∏–≤–µ–Ω –∏ –Ω–µ –∏—Å—Ç–µ–∫ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
3. –ò–Ω–∞—á–µ ‚Üí FREE

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è:
```typescript
const now = new Date();
const premiumExpired = premiumUntil ? new Date(premiumUntil) <= now : false;
const isPremiumActive = isPremium && !premiumExpired;
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç
- **FREE**: –î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å 1 –∞–Ω–∫–µ—Ç—É/–¥–µ–Ω—å
- **PRO**: –î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å 3 –∞–Ω–∫–µ—Ç—ã/–¥–µ–Ω—å
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å –±–æ–ª—å—à–µ ‚Üí –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ 429

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ
- **FREE**: 5 —Ñ–æ—Ç–æ/–¥–µ–Ω—å
- **PRO**: –ë–µ–∑–ª–∏–º–∏—Ç
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –°—á–µ—Ç—á–∏–∫ –≤ `user_limits.photos_sent_today` –∏–ª–∏ `web_user_limits.photos_sent_today`

### 3. –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç
- **FREE**: 1 —Ä–∞–∑ –≤ 3 –¥–Ω—è (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `last_pin_time`)
- **PRO**: 3 —Ä–∞–∑–∞/–¥–µ–Ω—å (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `pin_uses_today`)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í Telegram –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ "üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å"

### 4. –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—á–µ—Ç—á–∏–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –≤ 00:00 –ø–æ –ê–ª–º–∞—Ç—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–∞—Ç–∞ –≤ `*_last_reset` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

## üìù –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ Premium —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```
[ADS API] PRO –∏–∑ users: { isPremium: true, premium_until: '2025-12-11T23:59:59', expired: false }
[ADS API PIN] PRO –∏–∑ premium_tokens (Web): { isPremium: true, expired: false }
[MESSAGES API] PRO –∏–∑ users: { isPremium: false, expired: true }
```

–°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤:

```
[ADS API] –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π (–Ω–æ–≤—ã–π –¥–µ–Ω—å): { userId: 123, lastResetDate: '2025-11-20', currentDate: '2025-11-21' }
[PREMIUM API] –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ —Ñ–æ—Ç–æ (–Ω–æ–≤—ã–π –¥–µ–Ω—å –ø–æ –ê–ª–º–∞—Ç—ã UTC+5): { userId: 123, lastPhotosResetDate: '2025-11-20', currentDate: '2025-11-21' }
```

## ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
```
migrations/EXECUTE_NOW_analytics_and_users.sql
```

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç:
- `user_token` –≤ `page_visits` (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- `user_token` –≤ `users` (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Premium)
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
