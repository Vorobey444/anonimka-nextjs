# Migration 012: Nickname Change Tracking

## –î–∞—Ç–∞: 2025-11-11

## –¶–µ–ª—å
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–º–µ–Ω—ã –Ω–∏–∫–Ω–µ–π–º–∞ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π:
- **FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –û–î–ù–ê –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å–º–µ–Ω–∞ –Ω–∏–∫–Ω–µ–π–º–∞ (–ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- **PRO –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã –Ω–∏–∫–Ω–µ–π–º–∞ (—Ä–∞–∑ –≤ 24 —á–∞—Å–∞)

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ Neon Database Console
https://console.neon.tech

### 2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### 3. –û—Ç–∫—Ä–æ–π—Ç–µ SQL Editor

### 4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞ `migrations/012_add_nickname_change_tracking.sql`:

```sql
-- Migration 012: Add nickname change tracking for PRO users
-- Date: 2025-11-11
-- Purpose: Track last nickname change time to enforce limits (FREE: never, PRO: once per 24h)

BEGIN;

-- Add column to track when nickname was last changed
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS nickname_changed_at TIMESTAMPTZ;

-- Add comment
COMMENT ON COLUMN users.nickname_changed_at IS 'Timestamp of last nickname change (–¥–ª—è PRO: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑ –≤ 24 —á–∞—Å–∞)';

-- Create index for efficient querying
CREATE INDEX IF NOT EXISTS idx_users_nickname_changed_at ON users(nickname_changed_at);

COMMIT;
```

### 5. –ù–∞–∂–º–∏—Ç–µ "Run" –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ —Å–æ–∑–¥–∞–Ω–∞:

```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'users' AND column_name = 'nickname_changed_at';
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:
- `column_name`: nickname_changed_at
- `data_type`: timestamp with time zone
- `is_nullable`: YES

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–µ–∫—Å:

```sql
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'users' AND indexname = 'idx_users_nickname_changed_at';
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### API `/api/nickname` (POST)
–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. –ï—Å–ª–∏ `nickname_changed_at = NULL` (–ø–µ—Ä–≤–∞—è —Å–º–µ–Ω–∞) - —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –¥–ª—è FREE –∏ PRO
2. –ï—Å–ª–∏ `nickname_changed_at != NULL` (—É–∂–µ –±—ã–ª–∞ —Å–º–µ–Ω–∞):
   - FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –∑–∞–ø—Ä–µ—â–µ–Ω–æ (403) - –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å–º–µ–Ω–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞
   - PRO –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–º–µ–Ω—ã:
     - –ï—Å–ª–∏ < 24 —á–∞—Å–æ–≤ ‚Üí –∑–∞–ø—Ä–µ—â–µ–Ω–æ (429)
     - –ï—Å–ª–∏ ‚â• 24 —á–∞—Å–æ–≤ ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `nickname_changed_at`

### –ö–æ–¥—ã –æ—à–∏–±–æ–∫
- `NICKNAME_LOCKED_FREE` - FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –±–µ—Å–ø–ª–∞—Ç–Ω—É—é —Å–º–µ–Ω—É
- `NICKNAME_COOLDOWN` - PRO –¥–æ–ª–∂–µ–Ω –ø–æ–¥–æ–∂–¥–∞—Ç—å 24 —á–∞—Å–∞
- `NICKNAME_TAKEN` - –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç

### –§—Ä–æ–Ω—Ç–µ–Ω–¥
`public/webapp/app.js` - —Ñ—É–Ω–∫—Ü–∏—è `saveNicknamePage()` —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- üîí –î–ª—è FREE: "–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é —Å–º–µ–Ω—É –Ω–∏–∫–Ω–µ–π–º–∞. –û–±–Ω–æ–≤–∏—Ç–µ—Å—å –¥–æ PRO —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ!"
- ‚è≥ –î–ª—è PRO: "PRO –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å –Ω–∏–∫–Ω–µ–π–º —Ä–∞–∑ –≤ 24 —á–∞—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ X —á."
- ‚ùå "–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π."

## –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

```sql
BEGIN;

DROP INDEX IF EXISTS idx_users_nickname_changed_at;
ALTER TABLE users DROP COLUMN IF EXISTS nickname_changed_at;

COMMIT;
```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ö–æ–ª–æ–Ω–∫–∞ `nickname_changed_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Å–º–µ–Ω–µ –Ω–∏–∫–Ω–µ–π–º–∞
- –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Å–º–µ–Ω—ã `nickname_changed_at != NULL` ‚Üí FREE –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å
- PRO —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–≤–∫–ª—é—á–∞—è –ø—Ä–æ–≤–µ—Ä–∫—É –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ `premium_until`)
- –ò–Ω–¥–µ–∫—Å `idx_users_nickname_changed_at` —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–º–µ–Ω—ã

## –ü–æ–¥–∞—Ä–æ–∫ –¥–ª—è FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π üéÅ

FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç **–û–î–ù–£ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é —Å–º–µ–Ω—É –Ω–∏–∫–Ω–µ–π–º–∞** - —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±—ã–ª –≤—ã–±—Ä–∞–Ω –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –Ω–∏–∫–Ω–µ–π–º. –ü–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Å–º–µ–Ω –Ω—É–∂–µ–Ω PRO —Ç–∞—Ä–∏—Ñ.
