# üîê –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è **–æ–¥–Ω–∏–º –∏–∑ –¥–≤—É—Ö —Å–ø–æ—Å–æ–±–æ–≤**:

### üì± –í–∞—Ä–∏–∞–Ω—Ç 1: QR-–∫–æ–¥ (—Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω)

**–î–ª—è —á–µ–≥–æ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞, –Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç https://anonimka.kz/webapp/ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
2. –í–∏–¥–∏—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å QR-–∫–æ–¥–æ–º
3. –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ **–∫–∞–º–µ—Ä–æ–π –º–æ–±–∏–ª—å–Ω–æ–≥–æ Telegram**
4. Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞ @anonimka_kz_bot
5. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
6. **–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è**
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ **—Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞**

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫:**
```
–ö–æ–º–ø—å—é—Ç–µ—Ä (–±—Ä–∞—É–∑–µ—Ä)          –¢–µ–ª–µ—Ñ–æ–Ω (Telegram)           –°–µ—Ä–≤–µ—Ä (API)
       ‚îÇ                              ‚îÇ                         ‚îÇ
       ‚îú‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç auth_token       ‚îÇ                         ‚îÇ
       ‚îú‚îÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç QR —Å —Ç–æ–∫–µ–Ω–æ–º     ‚îÇ                         ‚îÇ
       ‚îÇ                              ‚îÇ                         ‚îÇ
       ‚îÇ        ‚óÑ‚îÄ‚îÄ‚îÄ –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR     ‚îÇ                         ‚îÇ
       ‚îÇ                              ‚îú‚îÄ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞         ‚îÇ
       ‚îÇ                              ‚îú‚îÄ /start auth_12345      ‚îÇ
       ‚îÇ                              ‚îÇ                         ‚îÇ
       ‚îÇ                              ‚îú‚îÄ POST /api/auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ                              ‚îÇ   {token, user_data}   ‚îÇ
       ‚îÇ                              ‚îÇ                         ‚îÇ
       ‚îú‚îÄ GET /api/auth?token=12345 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ {authorized: true, user} ‚îÇ
       ‚îÇ                              ‚îÇ                         ‚îÇ
       ‚îú‚îÄ –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ    ‚îÇ                         ‚îÇ
       ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage    ‚îÇ                         ‚îÇ
       ‚îú‚îÄ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É     ‚îÇ                         ‚îÇ
       ‚îÇ                              ‚îÇ                         ‚îÇ
       ‚ñº –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!                 ‚îÇ                         ‚îÇ
```

### üñ•Ô∏è –í–∞—Ä–∏–∞–Ω—Ç 2: Telegram Login Widget (—Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞)

**–î–ª—è —á–µ–≥–æ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –∏ —Ö–æ—á–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞).

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "Log in with Telegram"
2. –ù–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –Ω–µ—ë
3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è popup —Å Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
4. –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ postMessage
5. –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Frontend (app.js)

**–§—É–Ω–∫—Ü–∏–∏:**
- `checkTelegramAuth()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- `showTelegramAuthModal()` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç polling
- `generateTelegramQR(token)` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR-–∫–æ–¥ —Å deep link
- `initTelegramLoginWidget()` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Telegram Login Widget

**Polling –º–µ—Ö–∞–Ω–∏–∑–º:**
```javascript
setInterval(async () => {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    const response = await fetch(`/api/auth?token=${authToken}`);
    const data = await response.json();
    
    if (data.authorized) {
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
    }
}, 2000);
```

### 2. Backend API (route.ts)

**Endpoint:** `/api/auth`

**POST** - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```typescript
POST /api/auth
{
    "token": "auth_1762016108299_4hitqp9wj",
    "user": {
        "id": 884253640,
        "first_name": "–ê–ª–µ–∫—Å–µ–π",
        "username": "Vorobey_444"
    }
}
```

**GET** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
```typescript
GET /api/auth?token=auth_1762016108299_4hitqp9wj

Response:
{
    "authorized": true,
    "user": {...}
}
// –ò–õ–ò
{
    "authorized": false
}
```

**–•—Ä–∞–Ω–∏–ª–∏—â–µ:**
- In-memory Map (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ: Redis —Å TTL 5 –º–∏–Ω—É—Ç

### 3. Telegram Bot (bot.py)

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
```python
if auth_param.startswith('auth_'):
    # 1. –§–æ—Ä–º–∏—Ä—É–µ–º user_data
    user_data = {
        'id': user_id,
        'first_name': user.first_name,
        'username': user.username
    }
    
    # 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    async with aiohttp.ClientSession() as session:
        await session.post(
            f"{API_BASE_URL}/api/auth",
            json={'token': auth_param, 'user': user_data}
        )
    
    # 3. –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await update.message.reply_text("‚úÖ –û–∫–Ω–æ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏")
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–¢–æ–∫–µ–Ω—ã –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ** - –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
2. **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ 5 –º–∏–Ω—É—Ç** - —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞—é—Ç—Å—è
3. **CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω** - —Ç–æ–ª—å–∫–æ —Å –¥–æ–º–µ–Ω–∞ anonimka.kz
4. **–î–∞–Ω–Ω—ã–µ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** - —Ç–æ–ª—å–∫–æ –≤ localStorage –∫–ª–∏–µ–Ω—Ç–∞

## –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –í–º–µ—Å—Ç–æ polling ‚Üí WebSocket –∏–ª–∏ SSE

**Server-Sent Events (SSE):**
```javascript
const eventSource = new EventSource(`/api/auth/stream?token=${authToken}`);
eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.authorized) {
        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞!
    }
};
```

**WebSocket:**
```javascript
const ws = new WebSocket(`wss://anonimka.kz/ws/auth?token=${authToken}`);
ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
};
```

### Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

```typescript
import Redis from 'ioredis';
const redis = new Redis(process.env.REDIS_URL);

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å TTL 5 –º–∏–Ω—É—Ç
await redis.setex(`auth:${token}`, 300, JSON.stringify(userData));

// –ü–æ–ª—É—á–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å
const data = await redis.getdel(`auth:${token}`);
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://anonimka.kz/webapp/ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
2. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
3. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º
4. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –ª–æ–≥–∏:
   - `üîë Auth token —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: auth_...`
   - `‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ QR –ø–æ–ª—É—á–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞: {...}`
   - `‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–æ`

## –°—Ç–∞—Ç—É—Å

‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
- Telegram Login Widget
- API endpoint –¥–ª—è –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏
- –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- Frontend polling –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞

üîÑ –í –ø–ª–∞–Ω–∞—Ö
- WebSocket –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- Redis –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
