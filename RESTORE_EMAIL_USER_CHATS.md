# üîß –ú–∏–≥—Ä–∞—Ü–∏—è: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ `fix_email_tokens_deterministic.sql` —Ç–æ–∫–µ–Ω—ã email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ. –ù–æ —Å—Ç–∞—Ä—ã–µ —á–∞—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞–ª–∏—Å—å –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Å—Ç–∞—Ä—ã–º —Ç–æ–∫–µ–Ω–∞–º –∏ —Å—Ç–∞–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.

## –†–µ—à–µ–Ω–∏–µ

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `private_chats` –∏ `private_messages` —Å –Ω–æ–≤—ã–º–∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

1. –°–æ–∑–¥–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–∫–∞–∫ –≤ fix_email_tokens_deterministic.sql)
2. –°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –º–∞–ø–ø–∏–Ω–≥–æ–º —Å—Ç–∞—Ä—ã—Ö ‚Üí –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —á–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü–µ `private_chats`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `user_1_token` –Ω–∞ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `user_2_token` –Ω–∞ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
4. –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ `private_messages`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `sender_token` –Ω–∞ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `receiver_token` –Ω–∞ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
5. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### ‚ö†Ô∏è –ü–û–†–Ø–î–û–ö –í–ê–ñ–ï–ù!

**–°–Ω–∞—á–∞–ª–∞** –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ **–≤ —Ç–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ**:

1. `migrations/add_admin_panel_controls.sql` - –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –≤ –ë–î
2. `migrations/fix_email_tokens_deterministic.sql` - –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ users
3. `migrations/restore_email_user_chats.sql` - –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö —á–∞—Ç–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π ‚¨ÖÔ∏è **–≠–¢–ê**

### –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ Neon Console: https://console.neon.tc/
2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö ‚Üí SQL Editor
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `migrations/restore_email_user_chats.sql`
4. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor –∏ –Ω–∞–∂–º–∏—Ç–µ **Run**

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```
NOTICE:  Migration completed!
NOTICE:  Chats with updated tokens: X
NOTICE:  Messages with updated tokens: Y
NOTICE:  All email user chats have been restored with new deterministic tokens
```

## –ß—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

- ‚úÖ –í—Å–µ —á–∞—Ç—ã –º–µ–∂–¥—É email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–∏—Ö —á–∞—Ç–∞—Ö
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã —á–∞—Ç–æ–≤ (pending, accepted, rejected, blocked)

## –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

1. Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ —Å–≤–æ–∏ —Å—Ç–∞—Ä—ã–µ —á–∞—Ç—ã
2. –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
3. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```sql
-- –û—Ç–∫–∞—Ç - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è!)
-- –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ª—É—á—à–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∞—Ç—ã email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT pc.*, 
       u1.email as user_1_email,
       u2.email as user_2_email
FROM private_chats pc
LEFT JOIN users u1 ON pc.user_1_token = u1.user_token
LEFT JOIN users u2 ON pc.user_2_token = u2.user_token
WHERE u1.auth_method = 'email' OR u2.auth_method = 'email'
LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
SELECT COUNT(*) as message_count
FROM private_messages pm
LEFT JOIN users u ON pm.sender_token = u.user_token
WHERE u.auth_method = 'email';
```

## –í–∞–∂–Ω–æ!

‚ö†Ô∏è –≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è **–ü–û–°–õ–ï** `fix_email_tokens_deterministic.sql`!

–ï—Å–ª–∏ –≤—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –µ—ë —Ä–∞–Ω—å—à–µ –∏–ª–∏ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ Neon Console –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ:
1. add_admin_panel_controls.sql
2. fix_email_tokens_deterministic.sql
3. restore_email_user_chats.sql
