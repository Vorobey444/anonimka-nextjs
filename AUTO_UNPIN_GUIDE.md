# üìå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö –∞–Ω–∫–µ—Ç

## –ü—Ä–æ–±–ª–µ–º–∞
–ê–Ω–∫–µ—Ç—ã —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è (`pinned_until < NOW()`) –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å —Å —Ñ–ª–∞–≥–æ–º `is_pinned = TRUE` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–π –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:

### 1. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –∞–Ω–∫–µ—Ç
- **–ì–¥–µ:** `src/app/api/ads/route.ts` (GET –º–µ—Ç–æ–¥)
- **–ö–æ–≥–¥–∞:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ —Å–ø–∏—Å–∫–∞ –∞–Ω–∫–µ—Ç
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–µ–ø–ª—è–µ—Ç –≤—Å–µ –∞–Ω–∫–µ—Ç—ã —Å `pinned_until < NOW()`

### 2. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
- **–ì–¥–µ:** `pages/api/world-chat.js`
- **–ö–æ–≥–¥–∞:** –°–ª—É—á–∞–π–Ω–æ –≤ 10% –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ world-chat API
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ú–∞—Å—Å–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö PRO –∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–π

### 3. SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
```sql
-- –í—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏
SELECT * FROM unpin_expired_ads();

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
SELECT 
    COUNT(*) FILTER (WHERE is_pinned = true AND pinned_until > NOW()) as active_pinned,
    COUNT(*) FILTER (WHERE is_pinned = true AND pinned_until < NOW()) as expired_but_still_pinned
FROM ads;
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
# –í Supabase SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
psql -h <host> -U <user> -d <database> -f migrations/030_auto_unpin_expired.sql
```

–ò–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `migrations/030_auto_unpin_expired.sql` –≤ Supabase SQL Editor –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞
–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ –∏—Å—Ç–µ–∫—à–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–µ–Ω—ã.

```sql
-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 0 –≤ –∫–æ–ª–æ–Ω–∫–µ expired_but_still_pinned
SELECT 
    COUNT(*) FILTER (WHERE is_pinned = true AND pinned_until > NOW()) as active_pinned,
    COUNT(*) FILTER (WHERE is_pinned = true AND pinned_until < NOW()) as expired_but_still_pinned,
    COUNT(*) FILTER (WHERE is_pinned = false AND pinned_until IS NOT NULL) as unpinned
FROM ads;
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –ê–Ω–∫–µ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–µ–ø–ª—è—é—Ç—Å—è –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞  
‚úÖ –§–ª–∞–≥ `is_pinned` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `FALSE`  
‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å `idx_ads_expired_pins` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–∞—Å—Å–æ–≤–æ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∫–µ—Ç
