# Безопасность приложения

## Реализованные меры безопасности

### 1. Защита персональных данных

#### tg_id (Telegram ID)
- ✅ **НЕ возвращается** в публичных API ответах (GET /api/ads)
- ✅ Используется только для внутренней проверки владения ресурсами
- ✅ Хранится в БД, но не раскрывается публично
- ⚠️ **Не шифруется** в БД (хранится в plaintext для SQL запросов)

#### user_token
- ✅ Генерируется с использованием **crypto.randomBytes(32)** (криптографически безопасный)
- ✅ Используется для идентификации без раскрытия Telegram ID
- ✅ 64 hex символа (32 байта) - высокая энтропия

### 2. Аутентификация и авторизация

#### Проверка владения ресурсами
- ✅ DELETE /api/ads - проверяет tg_id перед удалением
- ✅ PATCH /api/ads - проверяет tg_id перед обновлением
- ✅ Все операции с анкетами требуют подтверждения владения

#### Валидация параметров
- ✅ Проверка наличия обязательных полей
- ✅ Возврат 400 Bad Request при отсутствии данных
- ✅ Возврат 401 Unauthorized при отсутствии авторизации
- ✅ Возврат 403 Forbidden при попытке изменить чужие ресурсы

### 3. Защита от SQL-инъекций

- ✅ Используются **parameterized queries** через `@vercel/postgres`
- ✅ Все значения передаются через `${variable}` в SQL tagged templates
- ✅ Автоматическое экранирование PostgreSQL драйвером

### 4. Логирование

#### Серверные логи
- ✅ **НЕ логируются** полные tg_id и user_token
- ✅ Логируются только ID ресурсов и статусы операций
- ✅ Безопасные сообщения типа "Блокировка добавлена" вместо данных

#### Клиентские логи (console.log)
- ✅ `ENABLE_DEBUG_LOGS = false` в продакшене
- ✅ Функция `safeLog()` хеширует чувствительные данные перед выводом
- ✅ Поддерживает хеширование: userId, tg_id, tgId, chatId, referrerId

### 5. Rate Limiting

- ✅ Лимиты на создание анкет: 1/день (FREE), 3/день (PRO)
- ✅ Лимиты на закрепление: 1/3дня (FREE), 3/день (PRO)
- ⚠️ **Нет** глобального rate limiting на уровне API
- ℹ️ Vercel предоставляет встроенные лимиты на уровне платформы

### 6. CORS и HTTP заголовки

- ✅ OPTIONS метод настроен для CORS
- ⚠️ Разрешены запросы с любых origin (`Access-Control-Allow-Origin: *`)
- ℹ️ Рекомендуется ограничить origin в продакшене

## Известные ограничения

### ⚠️ Требуют улучшения

1. **tg_id в БД не шифруется**
   - Хранится в plaintext для производительности SQL запросов
   - Рекомендация: мигрировать на UUID или хешировать при хранении

2. **Отсутствие JWT/Session**
   - Используется простая проверка tg_id из запроса
   - Рекомендация: внедрить JWT токены для API аутентификации

3. **CORS настроен на `*`**
   - Разрешены запросы с любых доменов
   - Рекомендация: ограничить до `anonimka.kz` и Telegram WebApp

4. **Нет глобального rate limiting**
   - Полагаемся на лимиты Vercel
   - Рекомендация: добавить Redis для точного контроля частоты запросов

## Рекомендации для продакшена

### Критические
- [ ] Настроить CORS на конкретные домены
- [ ] Внедрить JWT аутентификацию для API
- [ ] Добавить middleware для проверки Telegram WebApp data signature

### Важные
- [ ] Настроить rate limiting через Redis/Upstash
- [ ] Добавить логирование подозрительной активности
- [ ] Настроить алерты на аномальное поведение

### Желательные
- [ ] Шифровать tg_id в БД (AES-256)
- [ ] Добавить CAPTCHA на критические операции
- [ ] Внедрить audit log для всех изменений данных

## Проверочный список перед деплоем

- [x] `ENABLE_DEBUG_LOGS = false`
- [x] tg_id не возвращается в публичных API
- [x] Используется crypto.randomBytes для токенов
- [x] SQL запросы параметризованы
- [x] Логи не содержат чувствительных данных
- [ ] HTTPS включен (автоматически на Vercel)
- [ ] Environment variables настроены правильно
- [ ] Database credentials в секретах, не в коде

## Контакты

При обнаружении уязвимостей свяжитесь с разработчиками.
