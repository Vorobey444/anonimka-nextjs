# Настройка автоматической очистки старых анкет

## Что было сделано

### 1. API Endpoint для очистки
Создан `/api/cleanup` который:
- Удаляет анкеты старше 7 дней
- Удаляет связанные чаты
- Логирует количество удаленных записей

### 2. Vercel Cron Job
Добавлен автоматический запуск очистки:
- Время: каждый день в 03:00 UTC (06:00 по Алматы)
- Конфигурация в `vercel.json`

### 3. Безопасность
API защищен секретным ключом в заголовке Authorization.

## Настройка в Vercel

### Шаг 1: Добавьте переменную окружения
1. Откройте проект на https://vercel.com
2. Перейдите в **Settings** → **Environment Variables**
3. Добавьте новую переменную:
   - **Name**: `CRON_SECRET`
   - **Value**: `ваш-секретный-ключ-123` (придумайте свой)
   - **Environment**: Production, Preview, Development

### Шаг 2: Настройте Cron Job (автоматически)
Vercel автоматически определит конфигурацию из `vercel.json`:
```json
{
  "crons": [
    {
      "path": "/api/cleanup",
      "schedule": "0 3 * * *"
    }
  ]
}
```

**Schedule** `0 3 * * *` означает:
- Минута: 0
- Час: 3 (UTC)
- День месяца: * (каждый день)
- Месяц: * (каждый месяц)
- День недели: * (каждый день недели)

### Шаг 3: Редеплой
После добавления переменной сделайте редеплой:
```bash
git push
```

## Ручной запуск

### Проверка количества старых анкет (GET)
```bash
curl https://anonimka.kz/api/cleanup
```

Ответ:
```json
{
  "success": true,
  "oldAdsCount": 15,
  "message": "Найдено 15 анкет старше 7 дней, готовых к удалению"
}
```

### Запуск очистки вручную (POST)
```bash
curl -X POST https://anonimka.kz/api/cleanup \
  -H "Authorization: Bearer ваш-секретный-ключ-123"
```

Ответ:
```json
{
  "success": true,
  "deletedAds": 15,
  "message": "Удалено 15 анкет старше 7 дней"
}
```

## Мониторинг

Проверить логи Cron Job:
1. Откройте Vercel Dashboard
2. Перейдите в **Deployments** → выберите последний деплой
3. Откройте **Functions** → `/api/cleanup`
4. Проверьте логи выполнения

## Изменение расписания

Если хотите изменить время очистки, отредактируйте `vercel.json`:

```json
"schedule": "0 3 * * *"  // Каждый день в 03:00 UTC
"schedule": "0 */6 * * *"  // Каждые 6 часов
"schedule": "0 0 * * 0"  // Каждое воскресенье в полночь
```

После изменения сделайте `git push`.

## Проверка работы

После первого запуска проверьте:
1. Логи в Vercel Dashboard
2. Количество анкет в базе данных
3. GET запрос на `/api/cleanup` для статистики

## Безопасность

⚠️ **Важно**:
- Никогда не коммитьте `CRON_SECRET` в Git
- Используйте сложный случайный ключ
- Храните ключ только в Vercel Environment Variables
